# Шпаргалка по расчетным алгоритмам ЗУП

## Примерная схема вызова алгоритмов при начислении зарплаты

	Документ.НачислениеЗарплаты.Форма.ФормаДокумента.ОбработкаВыбора()
		Документ.НачислениеЗарплаты.Форма.ФормаДокумента.ОбработкаПодбораНаКлиенте()
			Документ.НачислениеЗарплаты.Форма.ФормаДокумента.ПерезаполнитьДанныеФормыНаСервере()
				ОбщийМодуль.РасчетЗарплатыРасширенный.ПерезаполнитьДанныеФормы()
					ОбщийМодуль.РасчетЗарплатыРасширенный.ПодготовитьДанныеДляПерезаполнения()
						
### 1. Обработка.МенеджерРасчетаЗарплаты.МодульОбъекта - Заполнение начислений

	ОбщийМодуль.РасчетЗарплатыРасширенный.ПодготовитьДанныеДляПерезаполнения()
		{...}
		ЗаполнитьНачислениеЗарплаты() ->
			НачисленияЗарплаты() ->
				ЗаполнитьВыявленнымиНачислениями() ->
					ЗаполнитьПризнакиПримененияНачислений()
					ДобавитьПлановыеНачисления() ->
						ДобавитьНачисленияСотрудников() ->
							ДобавитьСтрокуВыявленныхНачислений() ->
								ДобавитьСтрокуПлановыхНачислений() ->
									ДобавитьСтрокуНачислений()
								ДобавитьСтрокуНачисленийПоВидамВремени()
								ДобавитьСтрокуНачисленийПоПоказателям()
					ДобавитьНачисленияПоВидамВремени()
					ДобавитьНачисленияПоОперативнымПоказателям()
					ДобавитьНачисленияПоЗначениямРазовыхПоказателей()
					
					// !!! Нетиповые алгоритмы заполнения дополнительных начислений.
					РасчетЗарплатыРасширенныйПереопределяемый.ЗаполнитьДополнительныеНачисленияЗарплаты()
				{...}
				
				// Заполнение параметров начислений, кадровых данных.
				ЗаполнитьСведенияНачисленийДляРасчетаСлужебный() ->
					// СтрокаДополнительныхДанных.СуммированныйУчетРабочегоВремени =
					ЗаполнитьБазовыйПериодСтрокиНачисления() ->
						ЗаполнитьПризнакВремяВЧасахСтрокиНачисления()
							// Строка.ВремяВЧасах =	

#### Заполнение показателей и их значений

				ЗаполнитьЗначенияПоказателейНачислений() ->
					
					// Заполнение общей таблицы Начисления,
					// которая используется как результирующая таблица
					// со всеми данными для расчета.
					УстановитьТаблицуНачисления()

					ЗаполнитьЗначенияПоказателейНачисленийСлужебный() ->
						
##### Заполнение показателей

						// Собираются показатели, в зависимости от начислений и настроек программы.
						// Заполняется КэшПоказателиСотрудников.
						ПоказателиСотрудников() ->

							// Дополнительные показатели: тариф простоя, показатели среднего заработка, МРОТ и т. д.
							ДополнительныеПоказатели() ->
								
								// !!! Нетиповые алгоритмы добавления массива показателей,
								// используемых при расчете результата предопределенным способом.
								РасчетЗарплатыРасширенныйПереопределяемый.ПриОпределенииДополнительныхПоказателей()

							ТребованияНачисленийТаблица() ->
								ПланыВидовРасчета.Начисления.ТребованияНачисленийТаблица()

							// Собираются в кэш КэшПоказателиНачислений все показатели, всех используемых в текущем расчете начислений.
							ПоказателиНачислений() ->
								ПланыВидовРасчета.Начисления.ПоказателиНачислений(ОтборНачислений)

						ЗаполнитьЗначенияИзвестныхПоказателей(ПоказателиСотрудников.ИзвестныеПоказатели)
						{...}

##### Заполнение значений показателей

						// Далее идет заполнение значений показателей: периодические, разовые, кадровые.
						ЗаполнитьЗначенияПоказателяДоляНеполногоРабочегоВремени()
						ЗаполнитьЗначенияПоказателейСтоимостьЧасаДня()
						{...}						
						ЗаполнитьЗначенияПереопределяемыхПоказателейНачислений() ->
							
							// !!! Нетиповые алгоритмы заполнения значений показателей,
							// которые были добавлены в массив дополнительных показателей
							// методом ПриОпределенииДополнительныхПоказателей
							РасчетЗарплатыРасширенныйПереопределяемый.ЗаполнитьЗначенияДополнительныхПоказателейПоТаблицеЗначений()
		
### 2. Обработка.МенеджерРасчетаЗарплаты.МодульОбъекта - Рассчет начисленний

	ОбщийМодуль.РасчетЗарплатыРасширенный.ПодготовитьДанныеДляПерезаполнения()
		{...}
		РассчитатьЗарплату()
			РассчитатьЗарплатуСлужебный() ->
				ИнициализироватьРасчетБазыУдержаний()
					
					// Запись пустого набора записей для расчета базы и ФПД
					ДанныеТекущегоНабораНачисления() ->
						
						// Тут заполняется этот набор записей
						РасчетЗарплатыРасширенный.СформироватьДвиженияНачислений()

				// Если ударжания не рассчитываются,
				// то набоы записей для рассчета базы и ФПД
				// будут заполнены и записаны внутри этой процедуры
				ИнициализироватьРасчетБазыНачислений() ->
					// !!! Создает кэш КэшСтрокиНачисленийПоТребованиям
					// Раскладыает строки начислений по группам
					СтрокиНачисленийПоТребованиям()
					ТребованияНачисленийТаблица() ->
						ПланыВидовРасчета.Начисления.ТребованияНачисленийТаблица()

				РассчитатьНачисления()

					{...}
					// Заполняется фильтр рабочего времени на основании строк ФПД набора начислений,
					// и прочие параметры. Этот фильтр потом соединяется с графиками.
					ЗаполнитьФильтрПолученияРабочегоВремениПоДаннымТекущегоНабора();
						ЗаполнитьФильтрПолученияРабочегоВремени();
							// Тут посмотреть как именно заполняется фильтр рабочего времени.
							ДобавитьСтрокиФильтраРабочегоВремени();
								ТребованияТекущегоНачисления = ТребованияНачислений[СтрокаНабора.ВидРасчета];
								ЗаполнитьПоляФильтраРабочегоВремени()
									СтрокаФильтра.УчитыватьТолькоПраздничныеДни = ТребованияНачисления.ТребуютсяЗаПраздничныеДниПриОкончательномРасчете;
					{...}
					// !!! Расчет значений показателей: рабочее время, норма времени, календарные дни, оперативные показатели
					РассчитатьЗначенияПоказателейНачислений()
						
						РассчитатьЗначенияПоказателейРабочегоВремени() ->

							// Создает кэш КэшРабочееВремяСотрудников - данные о рабочем времени для дальнейших вычислений
							РабочееВремя()
								Обработка.МенеджерДанныхУчетаВремениСотрудников.РабочееВремяПоИсточникамДанных()
									{..}
									// Запрос в котором выбирается отработанное время, соединяется с таблицой фильтром
									ЗапросРабочееВремяПоИсточникамДанных()
							{...}
							ДанныеОВремениДляСтрокиНабора() ->

								// Строки периодов с данными о времени сравниваются с ФПД и отбрасываются те, которые не попадают в ФПД
								ЗаполнитьДанныеОВремениНачисленияЗаПериод()
							{...}
							ЗаполнитьРабочееВремяВСтроке()
							{...}
							// Установка значений показателей
							ЗаполнитьЗначениеПоказателяСтрокиРасчета()

						// !!!
						РассчитатьЗначенияПоказателейНормыВремени() ->
							// !!! Таблица содержит данные о норме времени по ФПД и за полная норма за месяц
							МенеджерУчетаВремени().НормаВремениПоИсточникамДанных()
						{...}
					РассчитатьНачисленияОчередности() ->
						
						РассчитатьНачисленияПоФормуле() ->
							РассчитатьРезультатНачисленияПоФормуле()
						
						РассчитатьНачисленияПредопределеннымСпособом()
							РассчитатьСтрокиНачисленийПредопределеннымСпособом
								ОбщийМодуль.УчетПособийСоциальногоСтрахованияРасширенный.РассчитатьПособиеПоСтрокамНабора()
								ПростоиСотрудников.РассчитатьОплатуПростояПоДаннымНабора()

								// !!! Нетиповые алгоритмы расчета начислений.
								РасчетЗарплатыРасширенныйПереопределяемый.РассчитатьСтрокуПредопределеннымСпособом()

						СкорректироватьИскажениеРезультата()
					{...}
					ЗавершитьПересчетНачислений()

### 3. Обработка.МенеджерРасчетаЗарплаты.МодульОбъекта - Формирование доходов по НДФЛ
			РассчитатьЗарплатуСлужебный()
			{...}
			РассчитатьНДФЛ() ->
				СформироватьДоходыНДФЛ() ->
					СформироватьДоходыНДФЛПоНачислениям() ->

			ОбщийМодуль.УчетНДФЛРасширенный.Модуль.СформироватьДоходыНДФЛПоНачислениям()
			ОбщийМодуль.УчетНДФЛ.Модуль.СформироватьДоходыНДФЛПоНачислениям()

## Настройки менеджера расчета зарплаты

	НастройкиРасчета.ПерваяПоловинаМесяца = Истина;

## Подсобные процедуры и фунции менеджера расчета зарплаты

	// Применяется в случаях, когда потребителю заранее известен один или несколько значений показателей начислений.
	ДобавитьИзвестноеЗначениеПоказателя()

	// Применяется при наличии в документе сведений о показателях, являющихся определяющими для начислений, 
	// то есть провоцирующих появление начислений.
	ДобавитьЗначениеОпределяющегоПоказателя()

	// !!!
	ЗаполнитьЗначениеПоказателяСтрокиРасчета(СтрокаТаблицыНачисления, НормаВремениВЧасах, СтрокиНормы[0].НормаЧасовПолная, Истина);
	// Пример:
	Строка = СтрокиНачисленийПоИдентификаторам[СтрокаПоказателя.ИдентификаторСтроки];
	ЗаполнитьЗначениеПоказателяСтрокиРасчета(Строка, СтрокаПоказателя.Показатель, СтрокаПоказателя.Значение);

	// Таблица Начисления перекладывается в соответствие по идентификатору
	СтрокиНачисленийПоИдентификаторам()

## Подсобные процедуры и функции

	// Добавить таблицу значений в менеджер временных таблиц
	ЗарплатаКадры.СоздатьВТПоТаблицеЗначений(МенеджерВременныхТаблиц, ДанныеТекущегоНабораУдержания.ТаблицаНабора, "ВТРегистрРасчета_Удержания", Истина);

	// Процедура заполняет план видов расчета т.н. псевдопредопределенными элементами, 
	// идентифицируемыми из кода.
	ПланВидовРасчета.Начисления.МодульОбъекта.СоздатьНачисленияПоНастройкам();
		ПланВидовРасчета.Начисления.МодульОбъекта.СоздатьИзменитьНачисленияПоОписанию()
			РасчетЗарплатыРасширенный.ЗаполнитьТаблицуПоказателейВидаРасчета();
				РасчетЗарплатыРасширенный.ПоказателиПредопределенногоСпособаРасчета()
					РасчетЗарплатыРасширенный.ТаблицаПоказателейПредопределенныхСпособовРасчета
						РасчетЗарплатыРасширенный.ЗаполнитьПоказателиРасчетаПредопределеннымСпособом()
							
							// !!! Заполнение сведений о показателях, используемых при расчете результата предопределенным способом.
							РасчетЗарплатыРасширенныйПереопределяемый.ЗаполнитьПоказателиРасчетаПредопределеннымСпособом()

## Прочие заметки

РС
ПараметрыЗарегистрированныхДанныхУчетаВремениСотрудников
ВидыВремениДляВыявленияНачислений
